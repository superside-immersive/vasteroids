<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Vasteroids</title>
    
    <!-- Libraries -->
    <script src="jquery-1.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="vector_battle_regular.typeface.js"></script>
    <script src="ipad.js"></script>

    <!-- UI Styles -->
    <link rel="stylesheet" href="src/styles/ui.css">
    
    <!-- Config -->
    <script src="src/config/constants.js"></script>
    
    <!-- Utilities -->
    <script src="src/utils/matrix.js"></script>
    <script src="src/utils/grid-node.js"></script>
    <script src="src/utils/text-renderer.js"></script>
    <script src="src/utils/glow-renderer.js"></script>

    <!-- UI Helpers -->
    <script src="src/ui/animations.js"></script>
    <script src="src/ui/hud.js"></script>
    <script src="src/ui/scoreboard.js"></script>
    <script src="src/ui/game-over.js"></script>
    <script src="src/ui/retro-fx.js"></script>
    
    <!-- Audio -->
    <script src="src/audio/sfx.js"></script>
    
    <!-- Input -->
    <script src="src/input/input-handler.js"></script>
    
    <!-- Entities -->
    <script src="src/entities/sprite.js"></script>
    <script src="src/entities/ship.js"></script>
    <script src="src/entities/bullet.js"></script>
    <script src="src/entities/alien.js"></script>
    <script src="src/entities/asteroid.js"></script>
    <script src="src/entities/explosion.js"></script>
    <script src="src/entities/data-fragment.js"></script>
    <script src="src/entities/silo.js"></script>
    <script src="src/entities/similarity-pickup.js"></script>
    
    <!-- Game -->
    <script src="src/game/game.js"></script>
    <script src="src/game/dase-mode.js"></script>
    <script src="src/game/similarity-mode.js"></script>
    <script src="src/game/game-fsm.js"></script>
    <script src="src/game/intro.js"></script>
    
    <!-- Main Entry Point -->
    <script src="src/main.js"></script>
    
    <style>
      body { 
        background: #0E142C; 
        color: #E5E7EB; 
        font-family: 'Orbitron', 'Audiowide', 'Courier New', monospace;
        margin: 0;
        padding: 20px;
      }
      
      #game-container { 
        background: #0E142C;
        position: relative;
        display: inline-block;
      }
      
      #canvas { 
        border: 1px solid #1FD9FE; 
        display: block;
        position: relative;
        z-index: 1;
      }
      
      .button { 
        position: absolute; 
        border: 1px solid #1FD9FE; 
        color: #E5E7EB; 
        background: transparent;
        font-family: 'Orbitron', 'Audiowide', 'Courier New', monospace;
      }
      
      #left-controls { 
        position: absolute; 
        left: 1px; 
        bottom: 0px; 
        display: none; 
      }
      
      #right-controls { 
        position: absolute; 
        right: 1px; 
        bottom: 0px; 
        display: none; 
      }
      
      #up { width: 200px; height: 100px; bottom: 100px; }
      #left { width: 100px; height: 100px; bottom: 0px; }
      #right { width: 100px; height: 100px; bottom: 0px; left: 100px; }
      #space { width: 200px; height: 200px; bottom: 0px; right: 0px; }
      
      .controls-info {
        margin-top: 20px;
        font-size: 12px;
        color: #9CA3AF;
      }
      
      .controls-info kbd {
        background: #1a2744;
        padding: 2px 6px;
        border-radius: 3px;
        border: 1px solid #1FD9FE;
      }

      .tuning-panel {
        margin-top: 14px;
        padding: 12px;
        border: 1px solid rgba(31, 217, 254, 0.4);
        border-radius: 10px;
        background: rgba(15, 22, 47, 0.6);
        max-width: 560px;
      }

      .tuning-title {
        font-size: 12px;
        color: #7cf0ff;
        letter-spacing: 1px;
        margin-bottom: 8px;
      }

      .tuning-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 8px 0;
        font-size: 12px;
        color: #E5E7EB;
      }

      .tuning-row input[type="range"] {
        flex: 1;
        height: 22px;
      }

      .tuning-value {
        width: 64px;
        text-align: right;
        font-variant-numeric: tabular-nums;
        color: #7cf0ff;
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <canvas id="canvas" width="540" height="960"></canvas>
      <div id="left-controls">
        <div id="up" class="button">THRUST</div>
        <div id="left" class="button">LEFT</div>
        <div id="right" class="button">RIGHT</div>
      </div>
      <div id="right-controls">
        <div id="space" class="button">FIRE</div>
      </div>
    </div>
    
    <div style="margin-top:12px; color:#E5E7EB; font-family: 'Orbitron', 'Audiowide', 'Courier New', monospace;">
      Letters per asteroid: 
      <input id="char-slider" type="range" min="40" max="400" step="10" value="200" style="width:240px; vertical-align:middle;">
      <span id="char-value" style="display:inline-block; width:40px; text-align:right;">200</span>
      <button id="toggle-retro-tv" aria-pressed="false" style="margin-left:10px; padding:6px 10px; background:#0f162f; color:#E5E7EB; border:1px solid #1FD9FE; border-radius:6px; cursor:pointer;">Retro TV: OFF</button>
    </div>
    
    <div class="controls-info">
      <p>
        <kbd>←</kbd> <kbd>→</kbd> Rotate | 
        <kbd>↑</kbd> Thrust | 
        <kbd>SPACE</kbd> Fire | 
        <kbd>SHIFT</kbd> Teleport | 
        <kbd>M</kbd> Mute |
        <kbd>F</kbd> FPS
      </p>
      <button id="test-next-level" style="margin-top:6px; padding:6px 10px; background:#0f162f; color:#E5E7EB; border:1px solid #1FD9FE; border-radius:6px; cursor:pointer;">Test NEXT LEVEL</button>
      <button id="test-similarity" style="margin-left:10px; padding:6px 10px; background:#0f162f; color:#FF00FF; border:1px solid #FF00FF; border-radius:6px; cursor:pointer;">Similarity Test</button>
      <button id="toggle-fps" aria-pressed="false" style="margin-left:10px; padding:6px 10px; background:#0f162f; color:#7cf0ff; border:1px solid #1FD9FE; border-radius:6px; cursor:pointer;">FPS: OFF</button>
      <span id="fps-readout" style="margin-left:10px; padding:6px 10px; color:#7cf0ff; border:1px solid rgba(31,217,254,0.35); border-radius:6px; display:none;">FPS: --</span>
      <a href="/qr-demo.html" target="_blank" style="margin-left:10px; padding:6px 10px; background:#0f162f; color:#7cf0ff; border:1px solid #1FD9FE; border-radius:6px; text-decoration:none; font-size:12px;">◫ QR DEMO CODES</a>
    </div>

    <div class="tuning-panel">
      <div class="tuning-title">SHIP ROTATION (LIVE)</div>
      <div class="tuning-row">
        <span>Start Rot °</span>
        <input id="ship-start-rot" type="range" min="0" max="360" step="0.1" value="0">
        <span class="tuning-value" id="ship-start-rot-val">0.0</span>
      </div>
      <div class="tuning-row">
        <span>Intro Rot °</span>
        <input id="ship-intro-rot" type="range" min="0" max="360" step="0.1" value="0">
        <span class="tuning-value" id="ship-intro-rot-val">0.0</span>
      </div>
    </div>

    <script>
      (function() {
        var btn = document.getElementById('test-next-level');
        if (btn) {
          btn.addEventListener('click', function() {
            if (window.Game && Game.sprites && Game.FSM) {
              // If in waiting state, start the game first
              if (Game.FSM.state === 'waiting') {
                window.gameStart = true;
                // Give FSM time to transition to run state
                setTimeout(function() {
                  // Now destroy all asteroids to trigger new_level
                  for (var i = 0; i < Game.sprites.length; i++) {
                    if (Game.sprites[i].name === 'asteroid') {
                      Game.sprites[i].die();
                    }
                  }
                }, 100);
              } else if (Game.FSM.state === 'run') {
                // Already running, just destroy asteroids
                for (var i = 0; i < Game.sprites.length; i++) {
                  if (Game.sprites[i].name === 'asteroid') {
                    Game.sprites[i].die();
                  }
                }
              }
            }
          });
        }
        
        // Similarity Test button
        var simBtn = document.getElementById('test-similarity');
        if (simBtn) {
          simBtn.addEventListener('click', function() {
            if (window.SimilarityMode && window.Game && Game.FSM && Game.FSM.state === 'run') {
              if (!SimilarityMode.isActive()) {
                SimilarityMode.activate();
                if (window.SFX && SFX.similarityActivate) {
                  SFX.similarityActivate();
                }
                simBtn.textContent = 'Similarity ACTIVE';
                simBtn.style.background = '#FF00FF';
                simBtn.style.color = '#000';
                setTimeout(function() {
                  simBtn.textContent = 'Similarity Test';
                  simBtn.style.background = '#0f162f';
                  simBtn.style.color = '#FF00FF';
                }, 2000);
              }
            } else {
              alert('Start the game first! (Press SPACE to start, then click this button)');
            }
          });
        }
      })();

      (function() {
        var startRot = document.getElementById('ship-start-rot');
        var introRot = document.getElementById('ship-intro-rot');
        var startRotVal = document.getElementById('ship-start-rot-val');
        var introRotVal = document.getElementById('ship-intro-rot-val');

        function setDefaults() {
          if (typeof window.SHIP_START_ROT_DEG === 'undefined') {
            window.SHIP_START_ROT_DEG = 0;
          }
          if (typeof window.SHIP_INTRO_ROT_DEG === 'undefined') {
            window.SHIP_INTRO_ROT_DEG = 0;
          }
          startRot.value = Number(window.SHIP_START_ROT_DEG).toFixed(1);
          introRot.value = Number(window.SHIP_INTRO_ROT_DEG).toFixed(1);
          startRotVal.textContent = Number(startRot.value).toFixed(1);
          introRotVal.textContent = Number(introRot.value).toFixed(1);
        }

        function applyStartRotation() {
          if (window.Game && Game.ship) {
            Game.ship.rot = window.SHIP_START_ROT_DEG;
          }
        }

        function bind() {
          startRot.addEventListener('input', function() {
            window.SHIP_START_ROT_DEG = parseFloat(startRot.value);
            startRotVal.textContent = Number(startRot.value).toFixed(1);
            applyStartRotation();
          });
          introRot.addEventListener('input', function() {
            window.SHIP_INTRO_ROT_DEG = parseFloat(introRot.value);
            introRotVal.textContent = Number(introRot.value).toFixed(1);
          });
        }

        if (startRot && introRot) {
          setDefaults();
          bind();
        }
      })();
    </script>
  </body>
</html>
