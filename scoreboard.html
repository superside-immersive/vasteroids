<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VASTEROIDS - Global Scoreboard</title>
  
  <!-- Web Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --ui-bg: rgba(14, 20, 44, 0.8);
      --ui-panel: rgba(18, 26, 54, 0.85);
      --ui-border: #1fd9fe;
      --ui-glow: 0 0 16px rgba(31, 217, 254, 0.35);
      --ui-text: #e5e7eb;
      --ui-muted: #9ca3af;
      --ui-accent: #7cf0ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0E142C;
      color: var(--ui-text);
      font-family: 'Orbitron', 'Courier New', monospace;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Starfield canvas background */
    #starfield {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    /* Main container */
    .container {
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* Panel styling - matches game */
    .scoreboard-panel {
      background: var(--ui-panel);
      border: 1px solid var(--ui-border);
      box-shadow: 
        var(--ui-glow),
        inset 0 0 60px rgba(0, 0, 0, 0.4),
        inset 0 0 100px rgba(0, 0, 0, 0.2);
      padding: 18px 22px;
      border-radius: 10px;
      min-width: 340px;
      max-width: 340px;
      width: 340px;
      position: relative;
      overflow: hidden;
    }

    /* Retro TV Scanlines Effect */
    .scoreboard-panel::before {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 100;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.15) 2px,
        rgba(0, 0, 0, 0.15) 4px
      );
      animation: scanlineFlicker 0.1s infinite;
    }

    /* Retro TV Noise Effect */
    .scoreboard-panel::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 101;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.06;
      animation: noiseAnimation 0.15s infinite steps(5);
    }

    /* Tracking bar for VHS/CRT effect */
    .retro-tracking-bar {
      position: absolute;
      left: 0;
      width: 100%;
      height: 20px;
      background: linear-gradient(
        180deg,
        transparent 0%,
        rgba(255, 255, 255, 0.08) 20%,
        rgba(255, 255, 255, 0.12) 50%,
        rgba(0, 0, 0, 0.1) 80%,
        transparent 100%
      );
      pointer-events: none;
      z-index: 99;
      animation: trackingBarMove 4s linear infinite;
    }

    @keyframes scanlineFlicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.97; }
    }

    @keyframes noiseAnimation {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-2%, -2%); }
      40% { transform: translate(2%, 1%); }
      60% { transform: translate(-1%, 2%); }
      80% { transform: translate(1%, -1%); }
      100% { transform: translate(0, 0); }
    }

    @keyframes trackingBarMove {
      0% { top: -30px; }
      100% { top: calc(100% + 30px); }
    }

    .title {
      text-align: center;
      font-size: 22px;
      margin-bottom: 10px;
      color: var(--ui-text);
      letter-spacing: 2px;
      position: relative;
      animation: rgbShift 3s ease-in-out infinite;
    }

    /* RGB chromatic aberration text effect */
    @keyframes rgbShift {
      0%, 100% {
        text-shadow: 
          0 0 12px rgba(124, 240, 255, 0.5),
          -1px 0 rgba(255, 0, 0, 0.3),
          1px 0 rgba(0, 255, 255, 0.3);
      }
      25% {
        text-shadow: 
          0 0 12px rgba(124, 240, 255, 0.5),
          -1px 0 rgba(255, 0, 0, 0.4),
          1px 0 rgba(0, 255, 255, 0.2);
      }
      50% {
        text-shadow: 
          0 0 12px rgba(124, 240, 255, 0.5),
          0px 0 rgba(255, 0, 0, 0.2),
          0px 0 rgba(0, 255, 255, 0.2);
      }
      75% {
        text-shadow: 
          0 0 12px rgba(124, 240, 255, 0.5),
          1px 0 rgba(255, 0, 0, 0.2),
          -1px 0 rgba(0, 255, 255, 0.4);
      }
    }

    /* Connection status */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 6px 10px;
      border: 1px solid rgba(31, 217, 254, 0.2);
      border-radius: 6px;
      font-size: 11px;
      color: var(--ui-muted);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f00;
      animation: pulse 2s infinite;
    }

    .status-dot.connected {
      background: #0f0;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Table styling - matches game exactly */
    .scoreboard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      color: var(--ui-text);
    }

    .scoreboard-table th,
    .scoreboard-table td {
      padding: 6px 4px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .scoreboard-table th {
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      color: var(--ui-muted);
      font-size: 12px;
    }

    .scoreboard-table td:first-child {
      width: 40px;
      text-align: center;
      color: var(--ui-muted);
    }

    .scoreboard-table td:last-child {
      text-align: right;
      font-weight: 600;
      color: #0f0;
    }

    .scoreboard-table tr.highlight td {
      color: var(--ui-accent);
      font-weight: bold;
      text-shadow: 0 0 10px rgba(124, 240, 255, 0.8);
    }

    .scoreboard-table tr.highlight {
      background: rgba(31, 217, 254, 0.15);
      animation: highlightPulse 1.5s ease-in-out infinite;
    }

    @keyframes highlightPulse {
      0%, 100% { background: rgba(31, 217, 254, 0.15); }
      50% { background: rgba(31, 217, 254, 0.3); }
    }

    /* Rank colors */
    .rank-1 { color: #ffd700 !important; text-shadow: 0 0 8px #ffd700; }
    .rank-2 { color: #c0c0c0 !important; text-shadow: 0 0 6px #c0c0c0; }
    .rank-3 { color: #cd7f32 !important; text-shadow: 0 0 6px #cd7f32; }

    /* Prompt pill - matches game */
    .prompt-pill {
      display: inline-block;
      margin-top: 12px;
      padding: 6px 12px;
      border: 1px solid var(--ui-border);
      border-radius: 999px;
      color: var(--ui-text);
      background: rgba(255, 255, 255, 0.03);
      box-shadow: var(--ui-glow);
      letter-spacing: 1px;
      font-size: 11px;
      text-align: center;
      width: 100%;
    }

    .prompt-pill a {
      color: var(--ui-accent);
      text-decoration: none;
    }

    .prompt-pill a:hover {
      text-decoration: underline;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--ui-muted);
    }

    .empty-state .icon {
      font-size: 36px;
      margin-bottom: 12px;
    }

    /* New score notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 255, 0, 0.15);
      border: 1px solid #0f0;
      padding: 12px 18px;
      border-radius: 8px;
      color: #0f0;
      font-size: 13px;
      transform: translateX(400px);
      transition: transform 0.3s ease-out;
      z-index: 100;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification .name {
      font-weight: bold;
      color: #fff;
    }

    .notification .score {
      color: var(--ui-accent);
    }
  </style>
</head>
<body>
  <!-- Animated starfield background -->
  <canvas id="starfield"></canvas>

  <div class="container">
    <div class="scoreboard-panel">
      <!-- Retro TV tracking bar -->
      <div class="retro-tracking-bar"></div>
      
      <div class="title">GLOBAL SCOREBOARD</div>
      
      <div class="status-bar">
        <div class="status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Connecting...</span>
        </div>
        <div id="updateInfo"></div>
      </div>

      <table class="scoreboard-table">
        <thead>
          <tr>
            <th>#</th>
            <th>NAME</th>
            <th>SCORE</th>
          </tr>
        </thead>
        <tbody id="scoresBody">
          <tr>
            <td colspan="3" class="empty-state">
              <div class="icon">üöÄ</div>
              <div>Loading scores...</div>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="prompt-pill">
        <a href="index.html">‚Üê PLAY VASTEROIDS</a>
      </div>
    </div>
  </div>

  <!-- New score notification -->
  <div class="notification" id="notification">
    NEW SCORE! <span class="name" id="notifName"></span> ‚Äî <span class="score" id="notifScore"></span>
  </div>

  <script>
    // =============================================
    // STARFIELD ANIMATION (same as game)
    // =============================================
    (function() {
      var canvas = document.getElementById('starfield');
      var ctx = canvas.getContext('2d');
      var stars = [];
      var STAR_COUNT = 120;

      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }

      function createStars() {
        stars = [];
        for (var i = 0; i < STAR_COUNT; i++) {
          stars.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            speed: 2 + Math.random() * 4,
            len: 8 + Math.random() * 16,
            alpha: 0.25 + Math.random() * 0.5
          });
        }
      }

      function render() {
        ctx.fillStyle = '#0E142C';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.lineCap = 'round';
        ctx.lineWidth = 1.5;

        for (var i = 0; i < stars.length; i++) {
          var s = stars[i];
          
          // Move star to the left
          s.x -= s.speed;
          
          // Draw horizontal streak
          var x1 = s.x;
          var x2 = s.x + s.len;
          var y = s.y;

          ctx.strokeStyle = 'rgba(124, 240, 255, ' + s.alpha + ')';
          ctx.beginPath();
          ctx.moveTo(x1, y);
          ctx.lineTo(x2, y);
          ctx.stroke();

          // Recycle stars from right edge
          if (x2 < 0) {
            s.x = canvas.width + Math.random() * 100;
            s.y = Math.random() * canvas.height;
            s.alpha = 0.25 + Math.random() * 0.5;
            s.speed = 2 + Math.random() * 4;
            s.len = 8 + Math.random() * 16;
          }
        }

        requestAnimationFrame(render);
      }

      window.addEventListener('resize', function() {
        resize();
        createStars();
      });

      resize();
      createStars();
      render();
    })();

    // =============================================
    // SCOREBOARD DATA & WEBSOCKET
    // =============================================
    (function() {
      function normalizeBaseUrl(value) {
        return String(value || '').trim().replace(/\/+$/, '');
      }

      function isLocalhostHost(hostname) {
        return hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '[::1]';
      }

      function resolveServerUrl() {
        try {
          var qs = new URLSearchParams(window.location.search || '');
          var fromQs = qs.get('server');
          if (fromQs) return normalizeBaseUrl(fromQs);
        } catch (e) {}

        try {
          if (window.VASTEROIDS_SERVER_URL) {
            return normalizeBaseUrl(window.VASTEROIDS_SERVER_URL);
          }
        } catch (e) {}

        // Sensible defaults by environment
        try {
          var hostname = (window.location && window.location.hostname) ? window.location.hostname : '';
          if (isLocalhostHost(hostname)) return 'http://localhost:3000';
          if (hostname && hostname.indexOf('onrender.com') !== -1) return normalizeBaseUrl(window.location.origin);
        } catch (e) {}

        return 'https://vasteroids-scoreboard.onrender.com';
      }

      function resolveWsUrl(serverUrl) {
        try {
          var u = new URL(serverUrl);
          u.protocol = (u.protocol === 'https:') ? 'wss:' : 'ws:';
          return u.toString().replace(/\/+$/, '');
        } catch (e) {
          return 'wss://vasteroids-scoreboard.onrender.com';
        }
      }

      var SERVER_URL = resolveServerUrl();
      var WS_URL = resolveWsUrl(SERVER_URL);
      
      var scores = [];
      var ws = null;
      var reconnectTimeout = null;
      var lastNewEntryId = null;

      var SESSION_PLACEHOLDERS_KEY = 'vasteroids.sessionPlaceholders.v1';
      var LAST_SERVER_SCORES_KEY = 'vasteroids.lastServerScores.v1';
      var hasServerSnapshot = false;

      var statusDot = document.getElementById('statusDot');
      var statusText = document.getElementById('statusText');
      var updateInfo = document.getElementById('updateInfo');
      var scoresBody = document.getElementById('scoresBody');
      var notification = document.getElementById('notification');
      var notifName = document.getElementById('notifName');
      var notifScore = document.getElementById('notifScore');

      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function loadLastServerScores() {
        try {
          var raw = localStorage.getItem(LAST_SERVER_SCORES_KEY);
          if (!raw) return null;
          var parsed = JSON.parse(raw);
          if (!parsed || !parsed.scores || !parsed.scores.length) return null;
          return parsed.scores;
        } catch (e) {
          return null;
        }
      }

      function persistLastServerScores(nextScores) {
        try {
          localStorage.setItem(LAST_SERVER_SCORES_KEY, JSON.stringify({
            at: Date.now(),
            scores: (nextScores || []).slice(0, 100)
          }));
        } catch (e) {}
      }

      function clearSessionPlaceholders() {
        try { sessionStorage.removeItem(SESSION_PLACEHOLDERS_KEY); } catch (e) {}
      }

      function ensureSessionPlaceholders() {
        try {
          var raw = sessionStorage.getItem(SESSION_PLACEHOLDERS_KEY);
          if (raw) {
            var parsed = JSON.parse(raw);
            if (parsed && parsed.scores && parsed.scores.length >= 100) {
              return parsed.scores.slice(0, 100);
            }
          }
        } catch (e) {}

        var namePool = [
          'NOVA', 'ACE', 'BLAZE', 'ORION', 'PULSE', 'DRIFT', 'KITE', 'ZEN', 'LUNA', 'VAST',
          'ECHO', 'BYTE', 'NEON', 'SOL', 'RIFT', 'STAR', 'VORTX', 'ION', 'FLUX', 'NIMBUS'
        ];

        var list = [];
        var score = 220000 + Math.floor(Math.random() * 40000);
        for (var i = 0; i < 100; i++) {
          var baseName = namePool[i % namePool.length];
          var suffix = (i >= namePool.length) ? String(i % 10) : '';
          var name = (baseName + suffix).substring(0, 8);
          var ratio = 0.86 + (Math.random() * 0.08);
          score = Math.max(250, Math.floor(score * ratio - (Math.random() * 1200)));
          if (i === 0) score = Math.max(score, 180000);
          if (i === 9) score = Math.min(score, 35000);
          list.push({
            id: 'ph-' + Date.now().toString(36) + '-' + i,
            name: name,
            score: score,
            placeholder: true,
            timestamp: new Date(Date.now() - (100 - i) * 60000).toISOString()
          });
        }
        list.sort(function(a, b) { return b.score - a.score; });
        list = list.slice(0, 100);
        try { sessionStorage.setItem(SESSION_PLACEHOLDERS_KEY, JSON.stringify({ at: Date.now(), scores: list })); } catch (e) {}
        return list;
      }

      function renderScores() {
        if (scores.length === 0) {
          scoresBody.innerHTML = 
            '<tr><td colspan="3" class="empty-state">' +
            '<div class="icon">üéÆ</div>' +
            '<div>No scores yet. Be the first!</div>' +
            '</td></tr>';
          return;
        }

        var html = '';
        var maxScores = 50; // Show top 50 scores
        var rowCount = Math.min(scores.length, maxScores);
        for (var i = 0; i < rowCount; i++) {
          var entry = scores[i];
          var rankClass = i < 3 ? 'rank-' + (i + 1) : '';
          var isNew = entry.id === lastNewEntryId;
          
          html += '<tr class="' + (isNew ? 'highlight' : '') + '" data-id="' + entry.id + '">' +
            '<td class="' + rankClass + '">' + (i + 1) + '</td>' +
            '<td>' + escapeHtml(entry.name) + '</td>' +
            '<td>' + formatNumber(entry.score) + '</td>' +
            '</tr>';
        }
        for (var j = rowCount; j < maxScores; j++) {
          html += '<tr>' +
            '<td>' + (j + 1) + '</td>' +
            '<td>---</td>' +
            '<td>---</td>' +
            '</tr>';
        }
        scoresBody.innerHTML = html;
      }

      function showNotification(entry) {
        notifName.textContent = entry.name;
        notifScore.textContent = formatNumber(entry.score);
        notification.classList.add('show');
        
        setTimeout(function() {
          notification.classList.remove('show');
        }, 4000);
      }

      function setStatus(connected, text) {
        statusDot.classList.toggle('connected', connected);
        statusText.textContent = text || (connected ? 'LIVE' : 'OFFLINE');
      }

      function connectWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) return;

        try {
          ws = new WebSocket(WS_URL);

          ws.onopen = function() {
            setStatus(true, 'LIVE');
            updateInfo.textContent = 'Real-time updates';
            hasServerSnapshot = true;
          };

          ws.onmessage = function(event) {
            try {
              var data = JSON.parse(event.data);
              
              if (data.type === 'init') {
                scores = data.scores || [];
                hasServerSnapshot = true;
                persistLastServerScores(scores);
                clearSessionPlaceholders();
                renderScores();
              } else if (data.type === 'new_score') {
                scores = data.scores || [];
                hasServerSnapshot = true;
                persistLastServerScores(scores);
                clearSessionPlaceholders();
                lastNewEntryId = data.entry ? data.entry.id : null;
                renderScores();
                if (data.entry) {
                  showNotification(data.entry);
                }
                // Clear highlight after animation
                setTimeout(function() {
                  lastNewEntryId = null;
                }, 3000);
              }
            } catch (err) {
              console.error('Parse error:', err);
            }
          };

          ws.onclose = function() {
            setStatus(false, 'RECONNECTING...');
            updateInfo.textContent = '';
            reconnectTimeout = setTimeout(connectWebSocket, 3000);
          };

          ws.onerror = function() {
            ws.close();
          };
        } catch (e) {
          setStatus(false, 'ERROR');
          reconnectTimeout = setTimeout(connectWebSocket, 5000);
        }
      }

      // Initial fetch as fallback
      function fetchScores() {
        fetch(SERVER_URL + '/api/scores')
          .then(function(res) { return res.json(); })
          .then(function(data) {
            scores = data.scores || [];
            hasServerSnapshot = true;
            persistLastServerScores(scores);
            clearSessionPlaceholders();
            renderScores();
          })
          .catch(function(err) {
            console.error('Fetch error:', err);
            // If we already had a server snapshot, keep it.
            if (hasServerSnapshot && scores && scores.length) {
              return;
            }
            // Offline fallback: last-known server snapshot or session placeholders.
            scores = loadLastServerScores() || ensureSessionPlaceholders();
            setStatus(false, 'OFFLINE');
            updateInfo.textContent = 'Showing local fallback';
            renderScores();
          });
      }

      // Initialize
      // Ensure something shows immediately even before network completes.
      scores = loadLastServerScores() || ensureSessionPlaceholders();
      renderScores();
      fetchScores();
      connectWebSocket();

      // Cleanup
      window.addEventListener('beforeunload', function() {
        if (reconnectTimeout) clearTimeout(reconnectTimeout);
        if (ws) ws.close();
      });
    })();
  </script>
</body>
</html>
